{"version":3,"file":"./js/build/auction.min.js","sources":["./js/auction/auction.js"],"names":["ELS","auctionName","document","getElementById","roommates","rooms","total","querySelector","remaining","adder","Auction","load","location","hash","substr","main","back","app","navigate","pathname","replace","err","auction","error","user","User","current","window","addUser","guard","addEventListeners","addEventReceiver","render","addBidListener","addNewRoomListener","addRemoveRoomListener","addContentListeners","ref","on","e","model","val","withDefaults","body","addEventListener","utils","debounced","target","matches","source","parentNode","Error","name","innerText","save","cache","preventDefault","bid","parseInt","childNodes","value","room","dataset","id","isNaN","rent","placeBid","renderBid","generateRoom","renderRoom","removeRoom","removeChild","classList","remove","renderUsers","renderRooms","renderAuctionCopy","renderPrices","size","length","prices","sum","forEach","bids","value_class","split","Math","ceil","Object","keys","parent","formatted","formatDollars","renderModel","pruneChildren","users","renderUser","renderBids","template","selector","existing","outerHTML","templates","node","renderNode","appendChild","register"],"mappings":"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","sourcesContent":["var ELS = {\n\tauctionName: document.getElementById('auction-name'),\n\troommates: document.getElementById('roommates'),\n\trooms: document.getElementById('rooms'),\n\ttotal: document.querySelector('.rent.total .dollars'),\n\tremaining: document.querySelector('.rent.remaining .dollars'),\n\tadder: document.querySelector('.adder')\n};\n\nAuction.load(location.hash.substr(1), main);\n\nfunction back() {\n\tapp.navigate(location.pathname.replace('auction', ''));\n}\n\nfunction main(err, auction) {\n\tif (err) app.error(err);\n\tif (!auction) return back();\n\tvar user = User.current();\n\twindow.auction = auction;\n\tauction.addUser(user, app.guard(function(){\n\t\taddEventListeners(user, auction);\n\t\taddEventReceiver(auction);\n\t\trender(auction);\n\t}));\n}\n\nfunction addEventListeners(user, auction) {\n\taddBidListener(user, auction);\n\taddNewRoomListener(auction);\n\taddRemoveRoomListener(auction);\n\taddContentListeners();\n}\n\nfunction addEventReceiver(auction) {\n\tauction.ref().on('value', function(e){\n\t\tauction.model = e.val();\n\t\trender(auction.withDefaults());\n\t}, app.guard());\n}\n\nfunction addContentListeners() {\n\tdocument.body.addEventListener(\"input\", utils.debounced(function(e){\n\t\tvar target = e.target;\n\t\tif (!utils.matches(target, \"[contenteditable=true]\"))\n\t\t\treturn;\n\t\tvar source = target.parentNode.source;\n\t\tif (!source)\n\t\t\tthrow new Error(\"unable to edit content without model source\");\n\t\tsource.model.name = target.innerText;\n\t\tsource.save(app.guard());\n\t\tif (source.cache) source.cache();\n\t}, 1500));\n}\n\nfunction addBidListener(user, auction) {\n\tELS.rooms.addEventListener(\"submit\", function(e){\n\t\te.preventDefault();\n\t\tvar bid = parseInt(e.target.childNodes[0].value, 10);\n\t\tvar room = auction.room(e.target.parentNode.dataset.id);\n\t\tif (isNaN(bid)) return app.error(\"please enter a valid bid amount\");\n\t\tif (bid < 1) return app.error(\"bids must be positive numbers\");\n\t\tif (bid > auction.rent) return app.error(\"bids must be less than the total rent\");\n\t\troom.placeBid(user, bid, app.guard(renderBid));\n\t});\n}\n\nfunction addNewRoomListener(auction) {\n\tELS.adder.addEventListener('click', function(e){\n\t\te.preventDefault();\n\t\tauction.generateRoom(app.guard(renderRoom));\n\t});\n}\n\nfunction addRemoveRoomListener(auction) {\n\tELS.rooms.addEventListener('click', function(e){\n\t\tif (!utils.matches(e.target, \".delete\")) return;\n\t\te.preventDefault();\n\t\tvar target = e.target.parentNode;\n\t\tif (!target.source) throw new Error(\"unable to delete room, missing model source\");\n\t\tauction.removeRoom(target.source, app.guard());\n\t\tif (target.parentNode)\n\t\t\ttarget.parentNode.removeChild(target);\n\t});\n}\n\nfunction render(auction) {\n\tdocument.body.classList.remove('loading');\n\trenderUsers(auction);\n\trenderRooms(auction);\n\trenderAuctionCopy(auction);\n\trenderPrices(auction);\n}\n\nfunction renderPrices(auction) {\n\n\tvar total = auction.model.rent;\n\tvar rooms = auction.rooms();\n\tvar size = rooms.length;\n\tvar prices = {};\n\tvar sum = 0;\n\n\t// first, get the prices for rooms with bids\n\trooms.forEach(function(room){\n\t\tvar model = { id: room.model.id };\n\t\tvar source = { model: model };\n\t\tprices[room.model.id] = source;\n\t\tvar bids = room.bids();\n\t\tswitch (bids.length) {\n\t\t\tcase 0: return;\n\t\t\tcase 1:\n\t\t\t\tmodel.value = bids[0].model.value;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tmodel.value = bids[1].model.value + 1;\n\t\t\t\tbreak;\n\t\t}\n\t\tsource.value_class = 'user';\n\t\tsource.user = bids[0].user;\n\t\tsum += model.value;\n\t\tsize--;\n\t});\n\n\t// next, split the remaining total amongst the non-bid rooms\n\tvar remaining = total - sum;\n\tvar split = Math.ceil(remaining / size);\n\trooms.forEach(function(room){\n\t\tvar model = prices[room.model.id].model;\n\t\tif (!model.value) model.value = split;\n\t});\n\n\t// render the prices into the price containers\n\tObject.keys(prices).forEach(function(id){\n\t\tvar source = prices[id];\n\t\tvar parent = ELS.rooms.querySelector('[data-id=\"'+id+'\"] .price-container');\n\t\tsource.model.formatted = utils.formatDollars(source.model.value);\n\t\trenderModel('price', source, parent);\n\t});\n\n\t// set the remaining bids available\n\tELS.remaining.value = remaining;\n\tELS.remaining.innerText = utils.formatDollars(remaining);\n\n}\n\nfunction renderAuctionCopy(auction) {\n\tvar total = auction.model.rent;\n\tELS.auctionName.parentNode.source = auction;\n\tELS.auctionName.innerText = auction.model.name;\n\tELS.total.innerText = utils.formatDollars(total);\n}\n\nfunction renderUsers(auction) {\n\tutils.pruneChildren(ELS.roommates, auction.model.users);\n\tauction.users().forEach(renderUser)\n}\n\nfunction renderRooms(auction) {\n\tutils.pruneChildren(ELS.rooms, auction.model.rooms);\n\tauction.rooms().forEach(renderRoom);\n}\n\nfunction renderUser(user) {\n\trenderModel('user', user, ELS.roommates);\n}\n\nfunction renderRoom(room) {\n\trenderModel('room', room, ELS.rooms);\n\trenderBids(room);\n}\n\nfunction renderBids(room) {\n\tvar parent = ELS.rooms.querySelector('[data-id=\"' + room.model.id + '\"] .bids');\n\tutils.pruneChildren(parent, room.model.bids);\n\troom.bids().forEach(function(bid){\n\t\trenderBid(bid, parent);\n\t});\n}\n\nfunction renderBid(bid, parent) {\n\tif (!parent)\n\t\tparent = ELS.rooms.querySelector('[data-id=\"' + bid.room.model.id + '\"] .bids');\n\trenderModel('bid', bid, parent);\n}\n\nfunction renderModel(template, source, parent) {\n\t//TODO: cache these?\n\tvar selector = '[data-id=\"' + source.model.id + '\"]';\n\tvar existing = parent.querySelector(selector);\n\tif (existing) {\n\t\texisting.outerHTML = templates.render(template, source);\n\t\tparent.querySelector(selector).source = source;\n\t} else {\n\t\tvar node = templates.renderNode(template, source);\n\t\tnode.source = source;\n\t\tparent.appendChild(node);\n\t}\n}\n\ntemplates.register('user',\n\t'<li class=\"user\" data-id=\"{{ model.id }}\">' +\n\t'<canvas class=\"avatar\" style=\"background-color:{{ model.color }}\"></canvas>' +\n\t'<h3 contenteditable=\"{{ current }}\">{{ model.name }}</h3>' +\n\t'</li>'\n);\n\ntemplates.register('room',\n\t'<li class=\"room\" data-id=\"{{ model.id }}\">' +\n\t'<h3 contenteditable=\"true\">{{ model.name }}</h3>' +\n\t'<a class=\"delete\">&times;</a>' +\n\t'<ul class=\"bids\"></ul>' +\n\t'<form>' +\n\t'<input class=\"bid\" type=\"number\" min=\"1\" step=\"1\" placeholder=\"Set bid...\" />' +\n\t'<button type=\"submit\">Bid!</button>' +\n\t'<div class=\"price-container\"></div>' +\n\t'</form>' +\n\t'</li>'\n);\n\ntemplates.register('price',\n\t'<div class=\"price\" data-id=\"{{ model.id }}\">' +\n\t'<canvas class=\"avatar\" style=\"background-color:{{ user.model.color }}\"></canvas>' +\n\t'<h4 class=\"value {{ value_class }}\">{{ model.formatted }}</h4>' +\n\t'</div>'\n);\n\ntemplates.register('bid',\n\t'<li class=\"bid\" data-id=\"{{ model.id }}\">' +\n\t'<canvas class=\"avatar\" style=\"background-color:{{ user.model.color }}\"></canvas>' +\n\t'<span class=\"value\">${{ model.value }}</span>' +\n\t'</li>'\n);"]}