{"version":3,"file":"./js/build/auction.min.js","sources":["./js/auction/auction.js"],"names":["ELS","auctionName","document","getElementById","roommates","rooms","total","querySelector","remaining","adder","Auction","load","location","hash","substr","main","back","app","navigate","pathname","replace","err","auction","error","user","User","current","window","addUser","guard","addEventListeners","addEventReceiver","render","addBidListener","addNewRoomListener","addRemoveRoomListener","addContentListeners","ref","on","e","model","val","withDefaults","body","addEventListener","utils","debounced","target","matches","source","parentNode","Error","name","innerText","save","cache","preventDefault","bid","parseInt","childNodes","value","room","dataset","id","isNaN","rent","placeBid","renderBid","generateRoom","renderRoom","removeRoom","removeChild","classList","remove","renderUsers","renderRooms","renderAuctionCopy","sumTopBids","formatDollars","pruneChildren","users","forEach","renderUser","renderModel","renderBids","parent","bids","template","selector","existing","outerHTML","templates","node","renderNode","appendChild","register"],"mappings":"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","sourcesContent":["var ELS = {\n\tauctionName: document.getElementById('auction-name'),\n\troommates: document.getElementById('roommates'),\n\trooms: document.getElementById('rooms'),\n\ttotal: document.querySelector('.rent.total .dollars'),\n\tremaining: document.querySelector('.rent.remaining .dollars'),\n\tadder: document.querySelector('.adder')\n};\n\nAuction.load(location.hash.substr(1), main);\n\nfunction back() {\n\tapp.navigate(location.pathname.replace('auction', ''));\n}\n\nfunction main(err, auction) {\n\tif (err) app.error(err);\n\tif (!auction) return back();\n\tvar user = User.current();\n\twindow.auction = auction;\n\tauction.addUser(user, app.guard(function(){\n\t\taddEventListeners(user, auction);\n\t\taddEventReceiver(auction);\n\t\trender(auction);\n\t}));\n}\n\nfunction addEventListeners(user, auction) {\n\taddBidListener(user, auction);\n\taddNewRoomListener(auction);\n\taddRemoveRoomListener(auction);\n\taddContentListeners();\n}\n\nfunction addEventReceiver(auction) {\n\tauction.ref().on('value', function(e){\n\t\tauction.model = e.val();\n\t\trender(auction.withDefaults());\n\t}, app.guard());\n}\n\nfunction addContentListeners() {\n\tdocument.body.addEventListener(\"input\", utils.debounced(function(e){\n\t\tvar target = e.target;\n\t\tif (!utils.matches(target, \"[contenteditable=true]\"))\n\t\t\treturn;\n\t\tvar source = target.parentNode.source;\n\t\tif (!source)\n\t\t\tthrow new Error(\"unable to edit content without model source\");\n\t\tsource.model.name = target.innerText;\n\t\tsource.save(app.guard());\n\t\tif (source.cache) source.cache();\n\t}, 1500));\n}\n\nfunction addBidListener(user, auction) {\n\tELS.rooms.addEventListener(\"submit\", function(e){\n\t\te.preventDefault();\n\t\tvar bid = parseInt(e.target.childNodes[0].value, 10);\n\t\tvar room = auction.room(e.target.parentNode.dataset.id);\n\t\tif (isNaN(bid)) return app.error(\"please enter a valid bid amount\");\n\t\tif (bid < 1) return app.error(\"bids must be positive numbers\");\n\t\tif (bid > auction.rent) return app.error(\"bids must be less than the total rent\");\n\t\troom.placeBid(user, bid, app.guard(renderBid));\n\t});\n}\n\nfunction addNewRoomListener(auction) {\n\tELS.adder.addEventListener('click', function(e){\n\t\te.preventDefault();\n\t\tauction.generateRoom(app.guard(renderRoom));\n\t});\n}\n\nfunction addRemoveRoomListener(auction) {\n\tELS.rooms.addEventListener('click', function(e){\n\t\tif (!utils.matches(e.target, \".delete\")) return;\n\t\te.preventDefault();\n\t\tvar target = e.target.parentNode;\n\t\tif (!target.source) throw new Error(\"unable to delete room, missing model source\");\n\t\tauction.removeRoom(target.source, app.guard());\n\t\tif (target.parentNode)\n\t\t\ttarget.parentNode.removeChild(target);\n\t});\n}\n\nfunction render(auction) {\n\tdocument.body.classList.remove('loading');\n\trenderUsers(auction);\n\trenderRooms(auction);\n\trenderAuctionCopy(auction);\n}\n\nfunction sumTopBids() {\n\tvar total = 0;\n\t//TODO: make this work\n\t//var nodes = document.querySelectorAll(\".bid:first-child .value\");\n\t//Array.prototype.slice.call(nodes).forEach(function(node){\n\t//\ttotal += parseInt(node.innerText, 10);\n\t//});\n\treturn total;\n}\n\nfunction renderAuctionCopy(auction) {\n\tvar total = auction.model.rent;\n\tELS.auctionName.parentNode.source = auction;\n\tELS.auctionName.innerText = auction.model.name;\n\tELS.total.innerText = utils.formatDollars(total);\n\tELS.remaining.innerText = utils.formatDollars(total-sumTopBids());\n}\n\nfunction renderUsers(auction) {\n\tutils.pruneChildren(ELS.roommates, auction.model.users);\n\tauction.users().forEach(renderUser)\n}\n\nfunction renderRooms(auction) {\n\tutils.pruneChildren(ELS.rooms, auction.model.rooms);\n\tauction.rooms().forEach(renderRoom);\n}\n\nfunction renderUser(user) {\n\trenderModel('user', user, ELS.roommates);\n}\n\nfunction renderRoom(room) {\n\trenderModel('room', room, ELS.rooms);\n\trenderBids(room);\n}\n\nfunction renderBids(room) {\n\tvar parent = ELS.rooms.querySelector('[data-id=\"' + room.model.id + '\"] .bids');\n\tutils.pruneChildren(parent, room.model.bids);\n\troom.bids().forEach(function(bid){\n\t\trenderBid(bid, parent);\n\t});\n}\n\nfunction renderBid(bid, parent) {\n\tif (!parent)\n\t\tparent = ELS.rooms.querySelector('[data-id=\"' + bid.room.model.id + '\"] .bids');\n\trenderModel('bid', bid, parent);\n}\n\nfunction renderModel(template, source, parent) {\n\t//TODO: cache these?\n\tvar selector = '[data-id=\"' + source.model.id + '\"]';\n\tvar existing = parent.querySelector(selector);\n\tif (existing) {\n\t\texisting.outerHTML = templates.render(template, source);\n\t\tparent.querySelector(selector).source = source;\n\t} else {\n\t\tvar node = templates.renderNode(template, source);\n\t\tnode.source = source;\n\t\tparent.appendChild(node);\n\t}\n}\n\ntemplates.register('user',\n\t'<li class=\"user\" data-id=\"{{ model.id }}\">' +\n\t'<div class=\"avatar\" style=\"background-image:{{ model.avatar }};background-color:{{ model.color }}\"></div>' +\n\t'<h3 contenteditable=\"{{ current }}\">{{ model.name }}</h3>' +\n\t'</li>'\n);\n\ntemplates.register('room',\n\t'<li class=\"room\" data-id=\"{{ model.id }}\">' +\n\t'<h3 contenteditable=\"true\">{{ model.name }}</h3>' +\n\t'<a class=\"delete\">&times;</a>' +\n\t'<ul class=\"bids\"></ul>' +\n\t'<form>' +\n\t'<input class=\"bid\" type=\"number\" min=\"1\" step=\"1\" placeholder=\"Place a bid...\" />' +\n\t'<button type=\"submit\">Bid!</button>' +\n\t'</form>' +\n\t'</li>'\n);\n\ntemplates.register('bid',\n\t'<li class=\"bid\" data-id=\"{{ model.id }}\">' +\n\t'<div class=\"avatar\" style=\"background-image:{{ user.model.avatar }};background-color:{{ user.model.color }}\"></div>' +\n\t'<span class=\"value\">${{ model.value }}</span>' +\n\t'</li>'\n);"]}