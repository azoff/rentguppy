{"version":3,"file":"./js/build/auction.min.js","sources":["./js/auction/auction.js"],"names":["ELS","auctionName","document","getElementById","roommates","rooms","total","querySelector","remaining","adder","Auction","load","location","hash","substr","main","back","app","navigate","pathname","replace","err","auction","error","user","User","current","window","addUser","guard","addEventListeners","addEventReceiver","render","addBidListener","addNewRoomListener","addRemoveRoomListener","addFocusBidListener","addContentListeners","addEventListener","e","utils","matches","target","nextSibling","childNodes","focus","ref","on","model","val","withDefaults","save","targeted","type","which","preventDefault","blur","key","dataset","source","parentNode","Error","innerText","cleanNumber","cache","mark","body","bid","value","room","id","isNaN","placeBid","renderBid","generateRoom","renderRoom","removeRoom","removeChild","classList","remove","renderUsers","renderRooms","renderAuctionCopy","renderPrices","rent","size","length","prices","sum","forEach","bids","value_class","split","Math","ceil","Object","keys","parent","formatted","formatDollars","renderModel","name","pruneChildren","users","renderUser","renderBids","template","noupdates","selector","existing","outerHTML","templates","node","renderNode","appendChild","register"],"mappings":"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","sourcesContent":["var ELS = {\n\tauctionName: document.getElementById('auction-name'),\n\troommates: document.getElementById('roommates'),\n\trooms: document.getElementById('rooms'),\n\ttotal: document.querySelector('.rent.total .dollars'),\n\tremaining: document.querySelector('.rent.remaining .dollars'),\n\tadder: document.querySelector('.adder')\n};\n\nAuction.load(location.hash.substr(1), main);\n\nfunction back() {\n\tapp.navigate(location.pathname.replace('auction', ''));\n}\n\nfunction main(err, auction) {\n\tif (err) app.error(err);\n\tif (!auction) return back();\n\tvar user = User.current();\n\twindow.auction = auction;\n\tauction.addUser(user, app.guard(function(){\n\t\taddEventListeners(user, auction);\n\t\taddEventReceiver(auction);\n\t\trender(auction);\n\t}));\n}\n\nfunction addEventListeners(user, auction) {\n\taddBidListener(user, auction);\n\taddNewRoomListener(auction);\n\taddRemoveRoomListener(auction);\n\taddFocusBidListener();\n\taddContentListeners();\n}\n\nfunction addFocusBidListener() {\n\tELS.rooms.addEventListener('click', function(e){\n\t\tif (!utils.matches(e.target, '.bids')) return;\n\t\te.target.nextSibling.childNodes[0].focus();\n\t});\n}\n\nfunction addEventReceiver(auction) {\n\tauction.ref().on('value', function(e){\n\t\tauction.model = e.val();\n\t\trender(auction.withDefaults());\n\t}, app.guard());\n}\n\nfunction addContentListeners() {\n\tvar target;\n\n\tfunction save(e) {\n\n\t\tif (!target) return;\n\t\tvar targeted = e.target === target;\n\t\tif (e.type === 'click' && targeted) return;\n\t\telse if (e.which !== 13 && e.which !== 27 && targeted) return;\n\t\telse if (e.type === 'keyup') e.preventDefault();\n\n\t\tif (targeted) target.blur();\n\n\t\tvar key = 'name';\n\t\tif (target.dataset.key)\n\t\t\tkey = target.dataset.key;\n\t\tvar source = target.parentNode.source;\n\t\tif (!source)\n\t\t\tthrow new Error(\"unable to edit content without model source\");\n\t\tsource.model[key] = target.innerText;\n\t\tif (target.dataset.type === 'number')\n\t\t\tsource.model[key] = utils.cleanNumber(source.model[key]);\n\t\tsource.save(app.guard());\n\t\tif (source.cache) source.cache();\n\n\t}\n\n\tfunction mark(e) {\n\t\tif (!utils.matches(e.target, \"[contenteditable=true]\")) return;\n\t\ttarget = e.target;\n\t}\n\n\tdocument.body.addEventListener('keyup', mark);\n\tdocument.body.addEventListener('paste', mark);\n\tdocument.body.addEventListener('input', mark);\n\tdocument.body.addEventListener('click', save);\n\tdocument.body.addEventListener('keyup', save);\n}\n\nfunction addBidListener(user, auction) {\n\tELS.rooms.addEventListener(\"submit\", function(e){\n\t\te.preventDefault();\n\t\tvar bid = utils.cleanNumber(e.target.childNodes[0].value);\n\t\tvar room = auction.room(e.target.parentNode.dataset.id);\n\t\tif (isNaN(bid)) return app.error(\"please enter a valid bid amount\");\n\t\tif (bid < 1) return app.error(\"bids must be positive numbers\");\n\t\tif (bid > ELS.remaining.value) return app.error(\"bids must be less than the remaining rent\");\n\t\troom.placeBid(user, bid, app.guard(renderBid));\n\t});\n}\n\nfunction addNewRoomListener(auction) {\n\tELS.adder.addEventListener('click', function(e){\n\t\te.preventDefault();\n\t\tauction.generateRoom(app.guard(renderRoom));\n\t});\n}\n\nfunction addRemoveRoomListener(auction) {\n\tELS.rooms.addEventListener('click', function(e){\n\t\tif (!utils.matches(e.target, \".delete\")) return;\n\t\te.preventDefault();\n\t\tvar target = e.target.parentNode;\n\t\tif (!target.source) throw new Error(\"unable to delete room, missing model source\");\n\t\tauction.removeRoom(target.source, app.guard());\n\t\tif (target.parentNode)\n\t\t\ttarget.parentNode.removeChild(target);\n\t});\n}\n\nfunction render(auction) {\n\tdocument.body.classList.remove('loading');\n\trenderUsers(auction);\n\trenderRooms(auction);\n\trenderAuctionCopy(auction);\n\trenderPrices(auction);\n}\n\nfunction renderPrices(auction) {\n\n\tvar total = auction.model.rent;\n\tvar rooms = auction.rooms();\n\tvar size = rooms.length;\n\tvar prices = {};\n\tvar sum = 0;\n\n\t// first, get the prices for rooms with bids\n\trooms.forEach(function(room){\n\t\tvar model = { id: room.model.id };\n\t\tvar source = { model: model };\n\t\tprices[room.model.id] = source;\n\t\tvar bids = room.bids();\n\t\tswitch (bids.length) {\n\t\t\tcase 0: return;\n\t\t\tcase 1:\n\t\t\t\tmodel.value = bids[0].model.value;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tmodel.value = bids[1].model.value + 1;\n\t\t\t\tbreak;\n\t\t}\n\t\tsource.value_class = 'user';\n\t\tsource.user = bids[0].user;\n\t\tsum += model.value;\n\t\tsize--;\n\t});\n\n\t// next, split the remaining total amongst the non-bid rooms\n\tvar remaining = total - sum;\n\tvar split = Math.ceil(remaining / size);\n\trooms.forEach(function(room){\n\t\tvar model = prices[room.model.id].model;\n\t\tif (!model.value) model.value = split;\n\t});\n\n\t// render the prices into the price containers\n\tObject.keys(prices).forEach(function(id){\n\t\tvar source = prices[id];\n\t\tvar parent = ELS.rooms.querySelector('[data-id=\"'+id+'\"] .price-container');\n\t\tsource.model.formatted = utils.formatDollars(source.model.value);\n\t\trenderModel('price', source, parent);\n\t});\n\n\t// set the remaining bids available\n\tELS.remaining.value = remaining;\n\tELS.remaining.innerText = utils.formatDollars(remaining);\n\n}\n\nfunction renderAuctionCopy(auction) {\n\tvar total = auction.model.rent;\n\tELS.total.parentNode.source = auction;\n\tELS.auctionName.parentNode.source = auction;\n\tELS.auctionName.innerText = auction.model.name;\n\tELS.total.innerText = utils.formatDollars(total);\n}\n\nfunction renderUsers(auction) {\n\tutils.pruneChildren(ELS.roommates, auction.model.users);\n\tauction.users().forEach(renderUser)\n}\n\nfunction renderRooms(auction) {\n\tutils.pruneChildren(ELS.rooms, auction.model.rooms);\n\tauction.rooms().forEach(renderRoom);\n}\n\nfunction renderUser(user) {\n\trenderModel('user', user, ELS.roommates);\n}\n\nfunction renderRoom(room) {\n\trenderModel('room', room, ELS.rooms, true);\n\trenderBids(room);\n}\n\nfunction renderBids(room) {\n\tvar parent = ELS.rooms.querySelector('[data-id=\"' + room.model.id + '\"] .bids');\n\tutils.pruneChildren(parent, room.model.bids);\n\troom.bids().forEach(function(bid){\n\t\trenderBid(bid, parent);\n\t});\n}\n\nfunction renderBid(bid, parent) {\n\tif (!parent)\n\t\tparent = ELS.rooms.querySelector('[data-id=\"' + bid.room.model.id + '\"] .bids');\n\trenderModel('bid', bid, parent);\n}\n\nfunction renderModel(template, source, parent, noupdates) {\n\t//TODO: cache these?\n\tvar selector = '[data-id=\"' + source.model.id + '\"]';\n\tvar existing = parent.querySelector(selector);\n\tif (existing) {\n\t\tif (!noupdates) {\n\t\t\texisting.outerHTML = templates.render(template, source);\n\t\t\tparent.querySelector(selector).source = source;\n\t\t}\n\t} else {\n\t\tvar node = templates.renderNode(template, source);\n\t\tnode.source = source;\n\t\tparent.appendChild(node);\n\t}\n}\n\ntemplates.register('user',\n\t'<li class=\"user\" data-id=\"{{ model.id }}\">' +\n\t'<canvas class=\"avatar\" style=\"background-color:{{ model.color }}\"></canvas>' +\n\t'<h3 contenteditable=\"{{ current }}\">{{ model.name }}</h3>' +\n\t'</li>'\n);\n\ntemplates.register('room',\n\t'<li class=\"room\" data-id=\"{{ model.id }}\">' +\n\t'<h3 contenteditable=\"true\">{{ model.name }}</h3>' +\n\t'<a class=\"delete\">&times;</a>' +\n\t'<ul class=\"bids\"></ul>' +\n\t'<form>' +\n\t'<input class=\"bid\" type=\"number\" min=\"1\" step=\"1\" placeholder=\"Set bid...\" />' +\n\t'<button type=\"submit\">Bid!</button>' +\n\t'<div class=\"price-container\"></div>' +\n\t'</form>' +\n\t'</li>'\n);\n\ntemplates.register('price',\n\t'<div class=\"price\" data-id=\"{{ model.id }}\">' +\n\t'<canvas class=\"avatar\" style=\"background-color:{{ user.model.color }}\"></canvas>' +\n\t'<h4 class=\"value {{ value_class }}\">{{ model.formatted }}</h4>' +\n\t'</div>'\n);\n\ntemplates.register('bid',\n\t'<li class=\"bid\" data-id=\"{{ model.id }}\">' +\n\t'<canvas class=\"avatar\" style=\"background-color:{{ user.model.color }}\"></canvas>' +\n\t'<span class=\"value\">${{ model.value }}</span>' +\n\t'</li>'\n);"]}