{"version":3,"file":"./js/build/auction.min.js","sources":["./js/auction/auction.js","./js/auction/video.js"],"names":["templates","register","ELS","auctionName","document","getElementById","roommates","rooms","total","querySelector","remaining","adder","Auction","load","location","hash","substr","main","back","app","navigate","pathname","replace","err","auction","error","user","User","current","window","addUser","guard","addEventListeners","addEventReceiver","render","utils","trigger","addBidListener","addNewRoomListener","addRemoveRoomListener","addRenderListener","addFocusBidListener","addContentListeners","addEventListener","e","matches","target","nextSibling","childNodes","focus","ref","on","model","val","withDefaults","save","targeted","type","which","preventDefault","blur","key","dataset","source","parentNode","Error","innerText","cleanNumber","cache","mark","body","room","id","value","bid","bids","length","isNaN","redactBid","placeBid","generateRoom","renderRoom","removeRoom","removeChild","classList","remove","renderUsers","renderRooms","renderAuctionCopy","renderPrices","rent","count","prices","bidcount","sum","forEach","len","value_class","opencount","split","Object","keys","parent","formatted","formatDollars","renderModel","name","pruneChildren","users","renderUser","renderBids","index","renderBid","template","selector","existing","node","rendered","renderNode","outerHTML","html","appendChild","indexMatches","insertBefore","media","video","audio","navigator","getUserMedia","webkitGetUserMedia","mozGetUserMedia","event","detail","connect","addNewPeerListener","addVideoClickListener","addPeerCallListeners","addExitListener","data","stream","peer","callUser","toggleStream","toggleMuted","mute","muted","disconnect","connectCall","call","acceptStream","message","from","answer","msg","toString","match","removePeer","disconnectUserStream","connectUserStream","setStream","shareStream","unload","to","connected"],"mappings":";CAAA,WAEC,YAEAA,WAAUC,SAAS,OAClB,6CACA,iIACA,4DACA,QAGDD,WAAUC,SAAS,OAClB,6CACA,mDACA,gCACA,yBACA,SACA,iFACA,sCACA,sCACA,UACA,QAGDD,WAAUC,SAAS,QAClB,+CACA,kGACA,iEACA,SAGDD,WAAUC,SAAS,MAClB,4CACA,kGACA,gDACA,QAGD,IAAIC,MACHC,YAAaC,SAASC,eAAe,gBACrCC,UAAWF,SAASC,eAAe,aACnCE,MAAOH,SAASC,eAAe,SAC/BG,MAAOJ,SAASK,cAAc,wBAC9BC,UAAWN,SAASK,cAAc,4BAClCE,MAAOP,SAASK,cAAc,UAG/BG,SAAQC,KAAKC,SAASC,KAAKC,OAAO,GAAIC,KAEtC,SAASC,QACRC,IAAIC,SAASN,SAASO,SAASC,QAAQ,UAAW,KAGnD,QAASL,MAAKM,IAAKC,SAClB,GAAID,IAAKJ,IAAIM,MAAMF,IACnB,KAAKC,QAAS,MAAON,OACrB,IAAIQ,MAAOC,KAAKC,SAChBC,QAAOL,QAAUA,OACjBA,SAAQM,QAAQJ,KAAMP,IAAIY,MAAM,WAC/BC,kBAAkBN,KAAMF,QACxBS,kBAAiBT,QACjBU,QAAOV,QACPW,OAAMC,QAAQP,OAAQ,SAAWL,QAASA,QAASE,KAAMA,UAI3D,QAASM,mBAAkBN,KAAMF,SAChCa,eAAeX,KAAMF,QACrBc,oBAAmBd,QACnBe,uBAAsBf,QACtBgB,mBAAkBhB,QAClBiB,sBACAC,uBAGD,QAASF,mBAAkBhB,SAC1BK,OAAOc,iBAAiB,SAAU,WACjCT,OAAOV,WAIT,QAASiB,uBACRvC,IAAIK,MAAMoC,iBAAiB,QAAS,SAASC,GAC5C,IAAKT,MAAMU,QAAQD,EAAEE,OAAQ,SAAU,MACvCF,GAAEE,OAAOC,YAAYC,WAAW,GAAGC,UAIrC,QAAShB,kBAAiBT,SACzBA,QAAQ0B,MAAMC,GAAG,QAAS,SAASP,GAClCpB,QAAQ4B,MAAQR,EAAES,KAClBnB,QAAOV,QAAQ8B,iBACbnC,IAAIY,SAGR,QAASW,uBACR,GAAII,OAEJ,SAASS,MAAKX,GAEb,IAAKE,OAAQ,MACb,IAAIU,UAAWZ,EAAEE,SAAWA,MAC5B,IAAIF,EAAEa,OAAS,SAAWD,SAAU,WAC/B,IAAIZ,EAAEc,QAAU,IAAMd,EAAEc,QAAU,IAAMF,SAAU,WAClD,IAAIZ,EAAEa,OAAS,QAASb,EAAEe,gBAE/B,IAAIH,SAAUV,OAAOc,MAErB,IAAIC,KAAM,MACV,IAAIf,OAAOgB,QAAQD,IAClBA,IAAMf,OAAOgB,QAAQD,GACtB,IAAIE,QAASjB,OAAOkB,WAAWD,MAC/B,KAAKA,OACJ,KAAM,IAAIE,OAAM,8CACjBF,QAAOX,MAAMS,KAAOf,OAAOoB,SAC3B,IAAIpB,OAAOgB,QAAQL,OAAS,SAC3BM,OAAOX,MAAMS,KAAO1B,MAAMgC,YAAYJ,OAAOX,MAAMS,KACpDE,QAAOR,KAAKpC,IAAIY,QAChB,IAAIgC,OAAOK,MAAOL,OAAOK,OACzBtB,QAAS,KAIV,QAASuB,MAAKzB,GACb,IAAKT,MAAMU,QAAQD,EAAEE,OAAQ,0BAA2B,MACxD,IAAIA,QAAUA,SAAWA,OAAQS,KAAKX,EACtCE,QAASF,EAAEE,OAGZ1C,SAASkE,KAAK3B,iBAAiB,UAAW0B,KAC1CjE,UAASkE,KAAK3B,iBAAiB,QAAS0B,KACxCjE,UAASkE,KAAK3B,iBAAiB,QAAS0B,KACxCjE,UAASkE,KAAK3B,iBAAiB,QAASY,KACxCnD,UAASkE,KAAK3B,iBAAiB,UAAWY,MAG3C,QAASlB,gBAAeX,KAAMF,SAC7BtB,IAAIK,MAAMoC,iBAAiB,SAAU,SAASC,GAE7CA,EAAEe,gBAEF,IAAIY,MAAO/C,QAAQ+C,KAAK3B,EAAEE,OAAOkB,WAAWF,QAAQU,GACpD,IAAIC,OAAQ7B,EAAEE,OAAOE,WAAW,GAAGyB,KACnC,IAAIC,KAAKC,KAAOJ,KAAKI,MAGrB,KAAKF,MAAO,CACX,GAAIE,KAAKC,OAAS,EAAG,CACpB,GAAID,KAAK,GAAGjD,KAAK0B,MAAMoB,KAAO9C,KAAK0B,MAAMoB,GACxC,MAAOrD,KAAIM,MAAM,qCACbiD,KAAMC,KAAK,GAAGvB,MAAMqB,MAAQ,MAC3B,CACNC,IAAM,OAED,CACNA,IAAMvC,MAAMgC,YAAYM,OAIzB,GAAII,MAAMH,KAAM,MAAOvD,KAAIM,MAAM,kCAGjC,IAAIiD,IAAM,EAAGH,KAAKO,UAAUpD,KAAMP,IAAIY,aACjCwC,MAAKQ,SAASrD,KAAMgD,IAAKvD,IAAIY,WAOpC,QAASO,oBAAmBd,SAC3BtB,IAAIS,MAAMgC,iBAAiB,QAAS,SAASC,GAC5CA,EAAEe,gBACFnC,SAAQwD,aAAa7D,IAAIY,MAAMkD,eAIjC,QAAS1C,uBAAsBf,SAC9BtB,IAAIK,MAAMoC,iBAAiB,QAAS,SAASC,GAC5C,IAAKT,MAAMU,QAAQD,EAAEE,OAAQ,WAAY,MACzCF,GAAEe,gBACF,IAAIb,QAASF,EAAEE,OAAOkB,UACtB,KAAKlB,OAAOiB,OAAQ,KAAM,IAAIE,OAAM,8CACpCzC,SAAQ0D,WAAWpC,OAAOiB,OAAQ5C,IAAIY,MAAM,WAC3C,GAAIe,OAAOkB,WACVlB,OAAOkB,WAAWmB,YAAYrC,aAKlC,QAASZ,QAAOV,SACfpB,SAASkE,KAAKc,UAAUC,OAAO,UAC/BC,aAAY9D,QACZ+D,aAAY/D,QACZgE,mBAAkBhE,QAClBiE,cAAajE,SAGd,QAASiE,cAAajE,SAErB,GAAIhB,OAAQgB,QAAQ4B,MAAMsC,IAC1B,IAAInF,OAAQiB,QAAQjB,OACpB,IAAIoF,OAAQpF,MAAMqE,MAClB,IAAIgB,UACJ,IAAIC,UAAW,CACf,IAAIC,KAAM,CAGVvF,OAAMwF,QAAQ,SAASxB,MACtB,GAAInB,QAAUoB,GAAID,KAAKnB,MAAMoB,GAC7B,IAAIT,SAAWX,MAAOA,MACtBwC,QAAOrB,KAAKnB,MAAMoB,IAAMT,MACxB,IAAIY,MAAOJ,KAAKI,MAChB,IAAIqB,KAAMrB,KAAKC,MACf,IAAIoB,KAAO,EAAG,MACd,IAAItB,KAAMC,KAAK,EACfZ,QAAOrC,KAAOgD,IAAIhD,IAClBqC,QAAOkC,YAAc,MACrB7C,OAAMqB,MAAQC,IAAItB,MAAMqB,KACxBqB,MAAO1C,MAAMqB,KACboB,aAID,IAAIK,WAAYP,MAAQE,QACxB,IAAInF,WAAYF,MAAQsF,GAGxB,IAAII,UAAY,EAAG,CAClB,GAAIC,OAAQzF,UAAYwF,SACxB3F,OAAMwF,QAAQ,SAASxB,MACtB,GAAIR,QAAS6B,OAAOrB,KAAKnB,MAAMoB,GAC/B,IAAIT,OAAOrC,KAAM,MACjBqC,QAAOX,MAAMqB,MAAQ0B,QAKvBC,OAAOC,KAAKT,QAAQG,QAAQ,SAASvB,IACpC,GAAIT,QAAS6B,OAAOpB,GACpB,IAAI8B,QAASpG,IAAIK,MAAME,cAAc,aAAa+D,GAAG,sBACrDT,QAAOX,MAAMmD,UAAYpE,MAAMqE,cAAczC,OAAOX,MAAMqB,MAC1DgC,aAAY,QAAS1C,OAAQuC,SAI9BpG,KAAIQ,UAAU+D,MAAQ/D,SACtBR,KAAIQ,UAAUwD,UAAY/B,MAAMqE,cAAc9F,WAI/C,QAAS8E,mBAAkBhE,SAC1B,GAAIhB,OAAQgB,QAAQ4B,MAAMsC,IAC1BxF,KAAIM,MAAMwD,WAAWD,OAASvC,OAC9BtB,KAAIC,YAAY6D,WAAWD,OAASvC,OACpCtB,KAAIC,YAAY+D,UAAY1C,QAAQ4B,MAAMsD,IAC1CxG,KAAIM,MAAM0D,UAAY/B,MAAMqE,cAAchG,OAG3C,QAAS8E,aAAY9D,SACpBW,MAAMwE,cAAczG,IAAII,UAAWkB,QAAQ4B,MAAMwD,MACjDpF,SAAQoF,QAAQb,QAAQc,YAGzB,QAAStB,aAAY/D,SACpBW,MAAMwE,cAAczG,IAAIK,MAAOiB,QAAQ4B,MAAM7C,MAC7CiB,SAAQjB,QAAQwF,QAAQd,YAGzB,QAAS4B,YAAWnF,MACnB+E,YAAY,OAAQ/E,KAAMxB,IAAII,WAG/B,QAAS2E,YAAWV,MACnBkC,YAAY,OAAQlC,KAAMrE,IAAIK,MAC9BuG,YAAWvC,MAGZ,QAASuC,YAAWvC,MACnB,GAAI+B,QAASpG,IAAIK,MAAME,cAAc,aAAe8D,KAAKnB,MAAMoB,GAAK,WACpErC,OAAMwE,cAAcL,OAAQ/B,KAAKnB,MAAMuB,KACvCJ,MAAKI,OAAOoB,QAAQ,SAASrB,IAAKqC,OACjCC,UAAUD,MAAOrC,IAAK4B,UAIxB,QAASU,WAAUD,MAAOrC,IAAK4B,QAC9B,IAAKA,OACJA,OAASpG,IAAIK,MAAME,cAAc,aAAeiE,IAAIH,KAAKnB,MAAMoB,GAAK,WACrEiC,aAAY,MAAO/B,IAAK4B,OAAQS,OAGjC,QAASN,aAAYQ,SAAUlD,OAAQuC,OAAQS,OAE9C,GAAIG,UAAW,aAAenD,OAAOX,MAAMoB,GAAK,IAChD,IAAI2C,UAAWb,OAAO7F,cAAcyG,SACpC,IAAIE,MAAMC,SAAWrH,UAAUsH,WAAWL,SAAUlD,OACpD,IAAIoD,SAAU,CACbC,KAAOD,QACP,IAAIE,SAASE,YAAcJ,SAASK,KAAM,CACzCL,SAASI,UAAYF,SAASE,SAC9BH,MAAOd,OAAO7F,cAAcyG,SAC5BE,MAAKI,KAAOH,SAASE,eAEhB,CACNH,KAAOC,QACPD,MAAKI,KAAOH,SAASE,SACrBjB,QAAOmB,YAAYJ,UAEpB,GAAIN,OAAS,IAAM5E,MAAMuF,aAAaX,MAAOK,KAAMd,QAClDA,OAAOqB,aAAaP,KAAMd,OAAOtD,WAAW+D,OAC7CK,MAAKrD,OAASA,aCvThB,WAEC,GAAI6D,QAAUC,MAAO,KAAMC,MAAO,KAClCC,WAAUC,aAAeD,UAAUC,cAAgBD,UAAUE,oBAAsBF,UAAUG,eAE7F,SAASjH,MAAKkH,OACb,GAAIzG,MAAOyG,MAAMC,OAAO1G,IACxB,IAAIF,SAAU2G,MAAMC,OAAO5G,OAC3BE,MAAK2G,QAAQlH,IAAIY,MAAM,WACtBC,kBAAkBN,KAAMF,YAI1B,QAASQ,mBAAkBN,KAAMF,SAChC8G,mBAAmB5G,KAAMF,QACzB+G,uBAAsB/G,QACtBgH,sBAAqB9G,KACrB+G,iBAAgB/G,MAGjB,QAAS4G,oBAAmB5G,KAAMF,SACjCA,QAAQ0B,IAAI,SAASC,GAAG,gBAAiB,SAASuF,MACjD,IAAKhH,KAAKmG,MAAMc,OAAQ,MACxB,IAAIvF,OAAQsF,KAAKrF,KACjB,IAAID,MAAMoB,KAAO9C,KAAK0B,MAAMoB,GAAI,MAChC,KAAKpB,MAAMwF,KAAM,MACjB,IAAIxF,MAAMwF,OAASpH,QAAQE,KAAK0B,MAAMoB,IAAIpB,MAAMwF,KAAM,MAEtDC,UAASnH,KAAM,GAAIC,MAAKyB,UAI1B,QAASmF,uBAAsB/G,SAC9BpB,SAASuC,iBAAiB,QAAS,SAASC,GAC3C,IAAKT,MAAMU,QAAQD,EAAEE,OAAQ,eAAgB,MAC7C,IAAIiB,QAASnB,EAAEE,OAAOkB,WAAWD,MACjC,KAAKA,OAAQ,KAAM,IAAIE,OAAM,wCAC7B,IAAIF,OAAOnC,QAASkH,aAAa/E,OAAQvC,aACpCuH,aAAYhF,UAInB,QAASgF,aAAYrH,MACpBA,KAAKmG,MAAMmB,MAAMtH,KAAKmG,MAAMoB,MAC5B9G,OAAMC,QAAQP,OAAQ,UAGvB,QAAS4G,iBAAgB/G,MACxBG,OAAOc,iBAAiB,eAAgB,WACvCjB,KAAKwH,WAAW/H,IAAIY,WAItB,QAASoH,aAAYC,KAAM1H,MAC1B0H,KAAKjG,GAAG,SAAUkG,aAAa3H,MAC/B0H,MAAKjG,GAAG,QAASkG,aAAa3H,MAC9B0H,MAAKjG,GAAG,QAAS,SAAS5B,KACzBJ,IAAIM,MAAMC,KAAK0B,MAAMsD,KAAO,mCAAoCnF,IAAI+H,SAAW/H,OAIjF,QAASiH,sBAAqB9G,MAC7BA,KAAKkH,OAAOzF,GAAG,OAAQ,SAASiG,MAC/B,GAAIG,MAAO/H,QAAQoH,KAAKQ,KAAKR,KAE7BQ,MAAKI,OAAO9H,KAAKmG,MAAMc,QAAU,KACjCQ,aAAYC,KAAMG,QAChBpG,GAAG,QAAS,SAAS5B,KACvB,GAAIkI,KAAMlI,IAAI+H,SAAW/H,IAAImI,UAC7B,IAAIC,OAAQF,IAAIE,MAAM,yBACtB,KAAKA,MAAOxI,IAAIM,MAAM,oCAAqCgI,SACtDG,YAAWD,MAAM,MAIxB,QAASC,YAAWhB,MACnB,GAAIlH,MAAOF,QAAQoH,KAAKA,KACxB,KAAKlH,KAAM,aACJA,MAAK0B,MAAMwF,IAClBlH,MAAK6B,KAAKpC,IAAIY,SAGf,QAAS+G,cAAapH,KAAMF,SAC3B,GAAIE,KAAKmG,MAAMc,OAAQkB,qBAAqBnI,UACvCoI,mBAAkBpI,KAAMF,SAG9B,QAASqI,sBAAqBnI,MAC7BqI,UAAUrI,KAAM,MAGjB,QAASoI,mBAAkBpI,KAAMF,SAChCuG,UAAUC,aAAaJ,MAAO,SAASe,QACtCoB,UAAUrI,KAAMiH,OAChBqB,aAAYtI,KAAMF,UAChBL,IAAIY,SAGR,QAASgI,WAAUrI,KAAMiH,QACxB,IAAKA,OAAQjH,KAAKmG,MAAMoC,aACnBvI,MAAKmG,MAAMhH,KAAK8H,OACrBxG,OAAMC,QAAQP,OAAQ,UAGvB,QAASmI,aAAYT,KAAM/H,SAC1BA,QAAQoF,QAAQb,QAAQ,SAASmE,IAChC,IAAKA,GAAG9G,MAAMwF,MAAQW,KAAKnG,MAAMwF,OAASsB,GAAG9G,MAAMwF,KAClD,MACDC,UAASU,KAAMW,MAIjB,QAASrB,UAASU,KAAMW,IACvB,IAAKA,GAAG9G,MAAMwF,KAAM,KAAM,IAAI3E,OAAM,4BACpC,KAAKsF,KAAKY,YAAa,KAAM,IAAIlG,OAAM,uBACvC,KAAKsF,KAAK1B,MAAMc,OAAQ,MAAO,IAAI1E,OAAM,8BACzCsF,MAAK1B,MAAMuB,KAAOG,KAAKX,OAAOQ,KAAKc,GAAG9G,MAAMwF,KAAMW,KAAK1B,MAAMc,OAE7DQ,aAAYI,KAAK1B,MAAMuB,KAAMc,IAG9B,QAASb,cAAa3H,MACrB,MAAO,UAASiH,QACfoB,UAAUrI,KAAMiH,SAIlB9G,OAAOc,iBAAiB,QAAS1B","sourcesContent":["(function(){\n\n\t\"use strict\";\n\n\ttemplates.register('user',\n\t\t'<li class=\"user\" data-id=\"{{ model.id }}\">' +\n\t\t'<video {{ video.attr }} {{ video.muted }} data-current=\"{{ current }}\" class=\"avatar\" style=\"color:{{ model.color }}\"></video>' +\n\t\t'<h3 contenteditable=\"{{ current }}\">{{ model.name }}</h3>' +\n\t\t'</li>'\n\t);\n\n\ttemplates.register('room',\n\t\t'<li class=\"room\" data-id=\"{{ model.id }}\">' +\n\t\t'<h3 contenteditable=\"true\">{{ model.name }}</h3>' +\n\t\t'<a class=\"delete\">&times;</a>' +\n\t\t'<ul class=\"bids\"></ul>' +\n\t\t'<form>' +\n\t\t'<input class=\"bid\" type=\"number\" min=\"0\" step=\"1\" placeholder=\"Your max...\" />' +\n\t\t'<button type=\"submit\">Bid!</button>' +\n\t\t'<div class=\"price-container\"></div>' +\n\t\t'</form>' +\n\t\t'</li>'\n\t);\n\n\ttemplates.register('price',\n\t\t'<div class=\"price\" data-id=\"{{ model.id }}\">' +\n\t\t'<video {{ user.video.attr }} muted class=\"avatar\" style=\"color:{{ user.model.color }}\"></video>' +\n\t\t'<h4 class=\"value {{ value_class }}\">{{ model.formatted }}</h4>' +\n\t\t'</div>'\n\t);\n\n\ttemplates.register('bid',\n\t\t'<li class=\"bid\" data-id=\"{{ model.id }}\">' +\n\t\t'<video {{ user.video.attr }} muted class=\"avatar\" style=\"color:{{ user.model.color }}\"></video>' +\n\t\t'<span class=\"value\">${{ model.value }}</span>' +\n\t\t'</li>'\n\t);\n\n\tvar ELS = {\n\t\tauctionName: document.getElementById('auction-name'),\n\t\troommates: document.getElementById('roommates'),\n\t\trooms: document.getElementById('rooms'),\n\t\ttotal: document.querySelector('.rent.total .dollars'),\n\t\tremaining: document.querySelector('.rent.remaining .dollars'),\n\t\tadder: document.querySelector('.adder')\n\t};\n\n\tAuction.load(location.hash.substr(1), main);\n\n\tfunction back() {\n\t\tapp.navigate(location.pathname.replace('auction', ''));\n\t}\n\n\tfunction main(err, auction) {\n\t\tif (err) app.error(err);\n\t\tif (!auction) return back();\n\t\tvar user = User.current();\n\t\twindow.auction = auction;\n\t\tauction.addUser(user, app.guard(function(){\n\t\t\taddEventListeners(user, auction);\n\t\t\taddEventReceiver(auction);\n\t\t\trender(auction);\n\t\t\tutils.trigger(window, 'ready', { auction: auction, user: user });\n\t\t}));\n\t}\n\n\tfunction addEventListeners(user, auction) {\n\t\taddBidListener(user, auction);\n\t\taddNewRoomListener(auction);\n\t\taddRemoveRoomListener(auction);\n\t\taddRenderListener(auction);\n\t\taddFocusBidListener();\n\t\taddContentListeners();\n\t}\n\n\tfunction addRenderListener(auction) {\n\t\twindow.addEventListener('render', function(){\n\t\t\trender(auction);\n\t\t});\n\t}\n\n\tfunction addFocusBidListener() {\n\t\tELS.rooms.addEventListener('click', function(e){\n\t\t\tif (!utils.matches(e.target, '.bids')) return;\n\t\t\te.target.nextSibling.childNodes[0].focus();\n\t\t});\n\t}\n\n\tfunction addEventReceiver(auction) {\n\t\tauction.ref().on('value', function(e){\n\t\t\tauction.model = e.val();\n\t\t\trender(auction.withDefaults());\n\t\t}, app.guard());\n\t}\n\n\tfunction addContentListeners() {\n\t\tvar target;\n\n\t\tfunction save(e) {\n\n\t\t\tif (!target) return;\n\t\t\tvar targeted = e.target === target;\n\t\t\tif (e.type === 'click' && targeted) return;\n\t\t\telse if (e.which !== 13 && e.which !== 27 && targeted) return;\n\t\t\telse if (e.type === 'keyup') e.preventDefault();\n\n\t\t\tif (targeted) target.blur();\n\n\t\t\tvar key = 'name';\n\t\t\tif (target.dataset.key)\n\t\t\t\tkey = target.dataset.key;\n\t\t\tvar source = target.parentNode.source;\n\t\t\tif (!source)\n\t\t\t\tthrow new Error(\"unable to edit content without model source\");\n\t\t\tsource.model[key] = target.innerText;\n\t\t\tif (target.dataset.type === 'number')\n\t\t\t\tsource.model[key] = utils.cleanNumber(source.model[key]);\n\t\t\tsource.save(app.guard());\n\t\t\tif (source.cache) source.cache();\n\t\t\ttarget = null;\n\n\t\t}\n\n\t\tfunction mark(e) {\n\t\t\tif (!utils.matches(e.target, \"[contenteditable=true]\")) return;\n\t\t\tif (target && target !== target) save(e);\n\t\t\ttarget = e.target;\n\t\t}\n\n\t\tdocument.body.addEventListener('keydown', mark);\n\t\tdocument.body.addEventListener('paste', mark);\n\t\tdocument.body.addEventListener('input', mark);\n\t\tdocument.body.addEventListener('click', save);\n\t\tdocument.body.addEventListener('keydown', save);\n\t}\n\n\tfunction addBidListener(user, auction) {\n\t\tELS.rooms.addEventListener('submit', function(e){\n\n\t\t\te.preventDefault();\n\n\t\t\tvar room = auction.room(e.target.parentNode.dataset.id);\n\t\t\tvar value = e.target.childNodes[0].value;\n\t\t\tvar bid, bids = room.bids();\n\n\t\t\t// find a default bid value if none was provided\n\t\t\tif (!value) {\n\t\t\t\tif (bids.length > 0) {\n\t\t\t\t\tif (bids[0].user.model.id === user.model.id)\n\t\t\t\t\t\treturn app.error('you already have the top bid!');\n\t\t\t\t\telse bid = bids[0].model.value + 1;\n\t\t\t\t} else {\n\t\t\t\t\tbid = 1;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tbid = utils.cleanNumber(value);\n\t\t\t}\n\n\t\t\t// validate the number submission\n\t\t\tif (isNaN(bid)) return app.error('please enter a valid bid amount');\n\n\t\t\t// remove the bid if less than 1, or add the bid if greater than 1\n\t\t\tif (bid < 1) room.redactBid(user, app.guard());\n\t\t\telse room.placeBid(user, bid, app.guard());\n\t\t\t//if (bid < 1) room.redactBid(user);\n\t\t\t//else room.placeBid(user, bid);\n\t\t\t//render(auction);\n\t\t});\n\t}\n\n\tfunction addNewRoomListener(auction) {\n\t\tELS.adder.addEventListener('click', function(e){\n\t\t\te.preventDefault();\n\t\t\tauction.generateRoom(app.guard(renderRoom));\n\t\t});\n\t}\n\n\tfunction addRemoveRoomListener(auction) {\n\t\tELS.rooms.addEventListener('click', function(e){\n\t\t\tif (!utils.matches(e.target, '.delete')) return;\n\t\t\te.preventDefault();\n\t\t\tvar target = e.target.parentNode;\n\t\t\tif (!target.source) throw new Error('unable to delete room, missing model source');\n\t\t\tauction.removeRoom(target.source, app.guard(function(){\n\t\t\t\tif (target.parentNode)\n\t\t\t\t\ttarget.parentNode.removeChild(target);\n\t\t\t}));\n\t\t});\n\t}\n\n\tfunction render(auction) {\n\t\tdocument.body.classList.remove('loading');\n\t\trenderUsers(auction);\n\t\trenderRooms(auction);\n\t\trenderAuctionCopy(auction);\n\t\trenderPrices(auction);\n\t}\n\n\tfunction renderPrices(auction) {\n\n\t\tvar total = auction.model.rent;\n\t\tvar rooms = auction.rooms();\n\t\tvar count = rooms.length;\n\t\tvar prices = {};\n\t\tvar bidcount = 0;\n\t\tvar sum = 0;\n\n\t\t// get the market price ranges for rooms\n\t\trooms.forEach(function(room){\n\t\t\tvar model = { id: room.model.id };\n\t\t\tvar source = { model: model };\n\t\t\tprices[room.model.id] = source;\n\t\t\tvar bids = room.bids();\n\t\t\tvar len = bids.length;\n\t\t\tif (len <= 0) return;\n\t\t\tvar bid = bids[0];\n\t\t\tsource.user = bid.user;\n\t\t\tsource.value_class = 'user';\n\t\t\tmodel.value = bid.model.value;\n\t\t\tsum += model.value;\n\t\t\tbidcount++;\n\t\t});\n\n\n\t\tvar opencount = count - bidcount;\n\t\tvar remaining = total - sum;\n\n\t\t// for open rooms, split the remainder evenly\n\t\tif (opencount > 0) {\n\t\t\tvar split = remaining / opencount;\n\t\t\trooms.forEach(function(room){\n\t\t\t\tvar source = prices[room.model.id];\n\t\t\t\tif (source.user) return;\n\t\t\t\tsource.model.value = split;\n\t\t\t});\n\t\t}\n\n\t\t// render the prices into the price containers\n\t\tObject.keys(prices).forEach(function(id){\n\t\t\tvar source = prices[id];\n\t\t\tvar parent = ELS.rooms.querySelector('[data-id=\"'+id+'\"] .price-container');\n\t\t\tsource.model.formatted = utils.formatDollars(source.model.value);\n\t\t\trenderModel('price', source, parent);\n\t\t});\n\n\t\t// render the remaining value\n\t\tELS.remaining.value = remaining;\n\t\tELS.remaining.innerText = utils.formatDollars(remaining);\n\n\t}\n\n\tfunction renderAuctionCopy(auction) {\n\t\tvar total = auction.model.rent;\n\t\tELS.total.parentNode.source = auction;\n\t\tELS.auctionName.parentNode.source = auction;\n\t\tELS.auctionName.innerText = auction.model.name;\n\t\tELS.total.innerText = utils.formatDollars(total);\n\t}\n\n\tfunction renderUsers(auction) {\n\t\tutils.pruneChildren(ELS.roommates, auction.model.users);\n\t\tauction.users().forEach(renderUser)\n\t}\n\n\tfunction renderRooms(auction) {\n\t\tutils.pruneChildren(ELS.rooms, auction.model.rooms);\n\t\tauction.rooms().forEach(renderRoom);\n\t}\n\n\tfunction renderUser(user) {\n\t\trenderModel('user', user, ELS.roommates);\n\t}\n\n\tfunction renderRoom(room) {\n\t\trenderModel('room', room, ELS.rooms);\n\t\trenderBids(room);\n\t}\n\n\tfunction renderBids(room) {\n\t\tvar parent = ELS.rooms.querySelector('[data-id=\"' + room.model.id + '\"] .bids');\n\t\tutils.pruneChildren(parent, room.model.bids);\n\t\troom.bids().forEach(function(bid, index){\n\t\t\trenderBid(index, bid, parent);\n\t\t});\n\t}\n\n\tfunction renderBid(index, bid, parent) {\n\t\tif (!parent)\n\t\t\tparent = ELS.rooms.querySelector('[data-id=\"' + bid.room.model.id + '\"] .bids');\n\t\trenderModel('bid', bid, parent, index);\n\t}\n\n\tfunction renderModel(template, source, parent, index) {\n\t\t//TODO: cache these?\n\t\tvar selector = '[data-id=\"' + source.model.id + '\"]';\n\t\tvar existing = parent.querySelector(selector);\n\t\tvar node, rendered = templates.renderNode(template, source);\n\t\tif (existing) {\n\t\t\tnode = existing;\n\t\t\tif (rendered.outerHTML !== existing.html) {\n\t\t\t\texisting.outerHTML = rendered.outerHTML;\n\t\t\t\tnode = parent.querySelector(selector);\n\t\t\t\tnode.html = rendered.outerHTML;\n\t\t\t}\n\t\t} else {\n\t\t\tnode = rendered;\n\t\t\tnode.html = rendered.outerHTML;\n\t\t\tparent.appendChild(rendered);\n\t\t}\n\t\tif (index >= 0 && !utils.indexMatches(index, node, parent))\n\t\t\tparent.insertBefore(node, parent.childNodes[index]);\n\t\tnode.source = source;\n\t}\n\n})();","(function(){\n\n\tvar media = { video: true, audio: true };\n\tnavigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;\n\n\tfunction main(event) {\n\t\tvar user = event.detail.user;\n\t\tvar auction = event.detail.auction;\n\t\tuser.connect(app.guard(function(){\n\t\t\taddEventListeners(user, auction);\n\t\t}));\n\t}\n\n\tfunction addEventListeners(user, auction) {\n\t\taddNewPeerListener(user, auction);\n\t\taddVideoClickListener(auction);\n\t\taddPeerCallListeners(user);\n\t\taddExitListener(user);\n\t}\n\n\tfunction addNewPeerListener(user, auction) {\n\t\tauction.ref('users').on('child_changed', function(data){\n\t\t\tif (!user.video.stream) return;\n\t\t\tvar model = data.val();\n\t\t\tif (model.id === user.model.id) return;\n\t\t\tif (!model.peer) return;\n\t\t\tif (model.peer === auction.user(model.id).model.peer) return;\n\t\t\t//console.log('detected change to', user.model.name, '@', user.model.peer);\n\t\t\tcallUser(user, new User(model));\n\t\t});\n\t}\n\n\tfunction addVideoClickListener(auction) {\n\t\tdocument.addEventListener('click', function(e){\n\t\t\tif (!utils.matches(e.target, '.user video')) return;\n\t\t\tvar source = e.target.parentNode.source;\n\t\t\tif (!source) throw new Error('unable to modify video without source');\n\t\t\tif (source.current) toggleStream(source, auction);\n\t\t\telse toggleMuted(source);\n\t\t});\n\t}\n\n\tfunction toggleMuted(user) {\n\t\tuser.video.mute(!user.video.muted);\n\t\tutils.trigger(window, 'render');\n\t}\n\n\tfunction addExitListener(user) {\n\t\twindow.addEventListener('beforeunload', function(){\n\t\t\tuser.disconnect(app.guard());\n\t\t});\n\t}\n\n\tfunction connectCall(call, user) {\n\t\tcall.on('stream', acceptStream(user));\n\t\tcall.on('close', acceptStream(user));\n\t\tcall.on('error', function(err){\n\t\t\tapp.error(user.model.name + \"'s connection is having issues: \", err.message || err);\n\t\t});\n\t}\n\n\tfunction addPeerCallListeners(user) {\n\t\tuser.peer().on('call', function(call){\n\t\t\tvar from = auction.peer(call.peer);\n\t\t\t//console.log('received call from', from.model.name, '@', from.model.peer);\n\t\t\tcall.answer(user.video.stream || null);\n\t\t\tconnectCall(call, from);\n\t\t}).on('error', function(err){\n\t\t\tvar msg = err.message || err.toString();\n\t\t\tvar match = msg.match(/connect to peer (\\w+)$/);\n\t\t\tif (!match) app.error(\"your connection is having issues:\", msg);\n\t\t\telse removePeer(match[1]);\n\t\t});\n\t}\n\n\tfunction removePeer(peer) {\n\t\tvar user = auction.peer(peer);\n\t\tif (!user) return;\n\t\tdelete user.model.peer;\n\t\tuser.save(app.guard());\n\t}\n\n\tfunction toggleStream(user, auction) {\n\t\tif (user.video.stream) disconnectUserStream(user);\n\t\telse connectUserStream(user, auction);\n\t}\n\n\tfunction disconnectUserStream(user) {\n\t\tsetStream(user, null);\n\t}\n\n\tfunction connectUserStream(user, auction) {\n\t\tnavigator.getUserMedia(media, function(stream){\n\t\t\tsetStream(user, stream);\n\t\t\tshareStream(user, auction);\n\t\t}, app.guard());\n\t}\n\n\tfunction setStream(user, stream) {\n\t\tif (!stream) user.video.unload();\n\t\telse user.video.load(stream);\n\t\tutils.trigger(window, 'render');\n\t}\n\n\tfunction shareStream(from, auction) {\n\t\tauction.users().forEach(function(to){\n\t\t\tif (!to.model.peer || from.model.peer === to.model.peer)\n\t\t\t\treturn; // skip on self or not connected\n\t\t\tcallUser(from, to);\n\t\t});\n\t}\n\n\tfunction callUser(from, to) {\n\t\tif (!to.model.peer) throw new Error('destination peer required');\n\t\tif (!from.connected()) throw new Error('source peer required');\n\t\tif (!from.video.stream) return new Error('source video stream missing');\n\t\tfrom.video.call = from.peer().call(to.model.peer, from.video.stream);\n\t\t//console.log('calling', to.model.name, '@', to.model.peer);\n\t\tconnectCall(from.video.call, to);\n\t}\n\n\tfunction acceptStream(user) {\n\t\treturn function(stream) {\n\t\t\tsetStream(user, stream);\n\t\t}\n\t}\n\n\twindow.addEventListener('ready', main);\n\n})();"]}