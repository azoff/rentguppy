{"version":3,"file":"./js/build/auction.min.js","sources":["./js/auction/auction.js","./js/auction/video.js"],"names":["ELS","auctionName","document","getElementById","roommates","rooms","total","querySelector","remaining","adder","Auction","load","location","hash","substr","main","back","app","navigate","pathname","replace","err","auction","error","user","User","current","window","addUser","guard","addEventListeners","addEventReceiver","render","utils","trigger","addBidListener","addNewRoomListener","addRemoveRoomListener","addFocusBidListener","addContentListeners","addEventListener","e","matches","target","nextSibling","childNodes","focus","ref","on","model","val","withDefaults","save","targeted","type","which","preventDefault","blur","key","dataset","source","parentNode","Error","innerText","cleanNumber","cache","mark","body","bid","value","room","id","isNaN","placeBid","renderBid","generateRoom","renderRoom","removeRoom","removeChild","classList","remove","renderUsers","renderRooms","renderAuctionCopy","renderPrices","rent","size","length","prices","sum","forEach","bids","value_class","split","Math","ceil","Object","keys","parent","formatted","formatDollars","renderModel","renderStreams","users","name","pruneChildren","renderUser","renderBids","template","noupdates","selector","existing","outerHTML","templates","node","renderNode","appendChild","register","navigator","getUserMedia","webkitGetUserMedia","mozGetUserMedia","event","detail","connect","shareStream","addVideoClickListener","addPeerCallListeners","addExitListener","addRenderListener","setStream","stream","video","toggleStream","peer","disconnect","call","answer","acceptStream","disconnectUserStream","connectUserStream","videos","querySelectorAll","src","URL","createObjectURL","Array","prototype","slice","their"],"mappings":"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","sourcesContent":["(function(){\n\n\t\"use strict\";\n\n\tvar ELS = {\n\t\tauctionName: document.getElementById('auction-name'),\n\t\troommates: document.getElementById('roommates'),\n\t\trooms: document.getElementById('rooms'),\n\t\ttotal: document.querySelector('.rent.total .dollars'),\n\t\tremaining: document.querySelector('.rent.remaining .dollars'),\n\t\tadder: document.querySelector('.adder')\n\t};\n\n\tAuction.load(location.hash.substr(1), main);\n\n\tfunction back() {\n\t\tapp.navigate(location.pathname.replace('auction', ''));\n\t}\n\n\tfunction main(err, auction) {\n\t\tif (err) app.error(err);\n\t\tif (!auction) return back();\n\t\tvar user = User.current();\n\t\twindow.auction = auction;\n\t\tauction.addUser(user, app.guard(function(){\n\t\t\taddEventListeners(user, auction);\n\t\t\taddEventReceiver(auction);\n\t\t\trender(auction);\n\t\t\tutils.trigger(window, 'ready', { auction: auction, user: user });\n\t\t}));\n\t}\n\n\tfunction addEventListeners(user, auction) {\n\t\taddBidListener(user, auction);\n\t\taddNewRoomListener(auction);\n\t\taddRemoveRoomListener(auction);\n\t\taddFocusBidListener();\n\t\taddContentListeners();\n\t}\n\n\tfunction addFocusBidListener() {\n\t\tELS.rooms.addEventListener('click', function(e){\n\t\t\tif (!utils.matches(e.target, '.bids')) return;\n\t\t\te.target.nextSibling.childNodes[0].focus();\n\t\t});\n\t}\n\n\tfunction addEventReceiver(auction) {\n\t\tauction.ref().on('value', function(e){\n\t\t\tauction.model = e.val();\n\t\t\trender(auction.withDefaults());\n\t\t}, app.guard());\n\t}\n\n\tfunction addContentListeners() {\n\t\tvar target;\n\n\t\tfunction save(e) {\n\n\t\t\tif (!target) return;\n\t\t\tvar targeted = e.target === target;\n\t\t\tif (e.type === 'click' && targeted) return;\n\t\t\telse if (e.which !== 13 && e.which !== 27 && targeted) return;\n\t\t\telse if (e.type === 'keyup') e.preventDefault();\n\n\t\t\tif (targeted) target.blur();\n\n\t\t\tvar key = 'name';\n\t\t\tif (target.dataset.key)\n\t\t\t\tkey = target.dataset.key;\n\t\t\tvar source = target.parentNode.source;\n\t\t\tif (!source)\n\t\t\t\tthrow new Error(\"unable to edit content without model source\");\n\t\t\tsource.model[key] = target.innerText;\n\t\t\tif (target.dataset.type === 'number')\n\t\t\t\tsource.model[key] = utils.cleanNumber(source.model[key]);\n\t\t\tsource.save(app.guard());\n\t\t\tif (source.cache) source.cache();\n\n\t\t}\n\n\t\tfunction mark(e) {\n\t\t\tif (!utils.matches(e.target, \"[contenteditable=true]\")) return;\n\t\t\ttarget = e.target;\n\t\t}\n\n\t\tdocument.body.addEventListener('keydown', mark);\n\t\tdocument.body.addEventListener('paste', mark);\n\t\tdocument.body.addEventListener('input', mark);\n\t\tdocument.body.addEventListener('click', save);\n\t\tdocument.body.addEventListener('keydown', save);\n\t}\n\n\tfunction addBidListener(user, auction) {\n\t\tELS.rooms.addEventListener(\"submit\", function(e){\n\t\t\te.preventDefault();\n\t\t\tvar bid = utils.cleanNumber(e.target.childNodes[0].value);\n\t\t\tvar room = auction.room(e.target.parentNode.dataset.id);\n\t\t\tif (isNaN(bid)) return app.error(\"please enter a valid bid amount\");\n\t\t\tif (bid < 1) return app.error(\"bids must be positive numbers\");\n\t\t\tif (bid > ELS.remaining.value) return app.error(\"bids must be less than the remaining rent\");\n\t\t\troom.placeBid(user, bid, app.guard(renderBid));\n\t\t});\n\t}\n\n\tfunction addNewRoomListener(auction) {\n\t\tELS.adder.addEventListener('click', function(e){\n\t\t\te.preventDefault();\n\t\t\tauction.generateRoom(app.guard(renderRoom));\n\t\t});\n\t}\n\n\tfunction addRemoveRoomListener(auction) {\n\t\tELS.rooms.addEventListener('click', function(e){\n\t\t\tif (!utils.matches(e.target, \".delete\")) return;\n\t\t\te.preventDefault();\n\t\t\tvar target = e.target.parentNode;\n\t\t\tif (!target.source) throw new Error(\"unable to delete room, missing model source\");\n\t\t\tauction.removeRoom(target.source, app.guard());\n\t\t\tif (target.parentNode)\n\t\t\t\ttarget.parentNode.removeChild(target);\n\t\t});\n\t}\n\n\tfunction render(auction) {\n\t\tdocument.body.classList.remove('loading');\n\t\trenderUsers(auction);\n\t\trenderRooms(auction);\n\t\trenderAuctionCopy(auction);\n\t\trenderPrices(auction);\n\t\tutils.trigger(window, 'rendered', { auction: auction });\n\t}\n\n\tfunction renderPrices(auction) {\n\n\t\tvar total = auction.model.rent;\n\t\tvar rooms = auction.rooms();\n\t\tvar size = rooms.length;\n\t\tvar prices = {};\n\t\tvar sum = 0;\n\n\t\t// first, get the prices for rooms with bids\n\t\trooms.forEach(function(room){\n\t\t\tvar model = { id: room.model.id };\n\t\t\tvar source = { model: model };\n\t\t\tprices[room.model.id] = source;\n\t\t\tvar bids = room.bids();\n\t\t\tswitch (bids.length) {\n\t\t\t\tcase 0: return;\n\t\t\t\tcase 1:\n\t\t\t\t\tmodel.value = bids[0].model.value;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tmodel.value = bids[1].model.value + 1;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tsource.value_class = 'user';\n\t\t\tsource.user = bids[0].user;\n\t\t\tsum += model.value;\n\t\t\tsize--;\n\t\t});\n\n\t\t// next, split the remaining total amongst the non-bid rooms\n\t\tvar remaining = total - sum;\n\t\tvar split = Math.ceil(remaining / size);\n\t\trooms.forEach(function(room){\n\t\t\tvar model = prices[room.model.id].model;\n\t\t\tif (!model.value) model.value = split;\n\t\t});\n\n\t\t// render the prices into the price containers\n\t\tObject.keys(prices).forEach(function(id){\n\t\t\tvar source = prices[id];\n\t\t\tvar parent = ELS.rooms.querySelector('[data-id=\"'+id+'\"] .price-container');\n\t\t\tsource.model.formatted = utils.formatDollars(source.model.value);\n\t\t\trenderModel('price', source, parent);\n\t\t});\n\n\t\t// set the remaining bids available\n\t\tELS.remaining.value = remaining;\n\t\tELS.remaining.innerText = utils.formatDollars(remaining);\n\n\t}\n\n\tfunction renderStreams(auction) {\n\t\tauction.users().forEach(function(user){\n\n\t\t});\n\t}\n\n\tfunction renderAuctionCopy(auction) {\n\t\tvar total = auction.model.rent;\n\t\tELS.total.parentNode.source = auction;\n\t\tELS.auctionName.parentNode.source = auction;\n\t\tELS.auctionName.innerText = auction.model.name;\n\t\tELS.total.innerText = utils.formatDollars(total);\n\t}\n\n\tfunction renderUsers(auction) {\n\t\tutils.pruneChildren(ELS.roommates, auction.model.users);\n\t\tauction.users().forEach(renderUser)\n\t}\n\n\tfunction renderRooms(auction) {\n\t\tutils.pruneChildren(ELS.rooms, auction.model.rooms);\n\t\tauction.rooms().forEach(renderRoom);\n\t}\n\n\tfunction renderUser(user) {\n\t\trenderModel('user', user, ELS.roommates);\n\t}\n\n\tfunction renderRoom(room) {\n\t\trenderModel('room', room, ELS.rooms, true);\n\t\trenderBids(room);\n\t}\n\n\tfunction renderBids(room) {\n\t\tvar parent = ELS.rooms.querySelector('[data-id=\"' + room.model.id + '\"] .bids');\n\t\tutils.pruneChildren(parent, room.model.bids);\n\t\troom.bids().forEach(function(bid){\n\t\t\trenderBid(bid, parent);\n\t\t});\n\t}\n\n\tfunction renderBid(bid, parent) {\n\t\tif (!parent)\n\t\t\tparent = ELS.rooms.querySelector('[data-id=\"' + bid.room.model.id + '\"] .bids');\n\t\trenderModel('bid', bid, parent);\n\t}\n\n\tfunction renderModel(template, source, parent, noupdates) {\n\t\t//TODO: cache these?\n\t\tvar selector = '[data-id=\"' + source.model.id + '\"]';\n\t\tvar existing = parent.querySelector(selector);\n\t\tif (existing) {\n\t\t\tif (!noupdates) {\n\t\t\t\texisting.outerHTML = templates.render(template, source);\n\t\t\t\tparent.querySelector(selector).source = source;\n\t\t\t}\n\t\t} else {\n\t\t\tvar node = templates.renderNode(template, source);\n\t\t\tnode.source = source;\n\t\t\tparent.appendChild(node);\n\t\t}\n\t}\n\n\ttemplates.register('user',\n\t\t'<li class=\"user\" data-id=\"{{ model.id }}\">' +\n\t\t'<video autoplay data-user=\"{{ model.id }}\" class=\"avatar\" style=\"background-color:{{ model.color }}\"></video>' +\n\t\t'<h3 contenteditable=\"{{ current }}\">{{ model.name }}</h3>' +\n\t\t'</li>'\n\t);\n\n\ttemplates.register('room',\n\t\t'<li class=\"room\" data-id=\"{{ model.id }}\">' +\n\t\t'<h3 contenteditable=\"true\">{{ model.name }}</h3>' +\n\t\t'<a class=\"delete\">&times;</a>' +\n\t\t'<ul class=\"bids\"></ul>' +\n\t\t'<form>' +\n\t\t'<input class=\"bid\" type=\"number\" min=\"1\" step=\"1\" placeholder=\"Set bid...\" />' +\n\t\t'<button type=\"submit\">Bid!</button>' +\n\t\t'<div class=\"price-container\"></div>' +\n\t\t'</form>' +\n\t\t'</li>'\n\t);\n\n\ttemplates.register('price',\n\t\t'<div class=\"price\" data-id=\"{{ model.id }}\">' +\n\t\t'<video autoplay data-user=\"{{ user.model.id }}\" class=\"avatar\" style=\"background-color:{{ user.model.color }}\"></video>' +\n\t\t'<h4 class=\"value {{ value_class }}\">{{ model.formatted }}</h4>' +\n\t\t'</div>'\n\t);\n\n\ttemplates.register('bid',\n\t\t'<li class=\"bid\" data-id=\"{{ model.id }}\">' +\n\t\t'<video autoplay data-user=\"{{ user.model.id }}\" class=\"avatar\" style=\"background-color:{{ user.model.color }}\"></video>' +\n\t\t'<span class=\"value\">${{ model.value }}</span>' +\n\t\t'</li>'\n\t);\n\n})();","(function(){\n\n\tnavigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;\n\n\tfunction main(event) {\n\t\tvar user = event.detail.user;\n\t\tvar auction = event.detail.auction;\n\t\tuser.connect(app.guard());\n\t\taddEventListeners(user, auction);\n\t\tshareStream(user, auction);\n\t}\n\n\tfunction addEventListeners(user, auction) {\n\t\taddVideoClickListener(user, auction);\n\t\taddPeerCallListeners(user);\n\t\taddExitListener(user);\n\t\taddRenderListener(auction);\n\t}\n\n\tfunction addRenderListener(auction) {\n\t\twindow.addEventListener('rendered', function(){\n\t\t\tauction.users().forEach(function(user){\n\t\t\t\tsetStream(user, user.stream);\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction addVideoClickListener(user, auction) {\n\t\tdocument.addEventListener('click', function(e){\n\t\t\tif (!utils.matches(e.target, '.user video')) return;\n\t\t\tvar video = e.target;\n\t\t\tvar node = video.parentNode;\n\t\t\tvar source = node.source;\n\t\t\tif (!source) throw new Error('unable to modify video without source');\n\t\t\tif (source.model.id === user.model.id)\n\t\t\t\ttoggleStream(user, auction);\n\t\t});\n\t}\n\n\tfunction addExitListener(user) {\n\t\twindow.addEventListener('beforeunload', function(){\n\t\t\tuser.peer.disconnect(true, app.guard());\n\t\t});\n\t}\n\n\tfunction addPeerCallListeners(user) {\n\t\tuser.peer.on('call', function(call){\n\t\t\tvar user = auction.peer(call.peer);\n\t\t\tcall.answer(user.stream);\n\t\t\tcall.on('stream', acceptStream(user));\n\t\t\tcall.on('close', acceptStream(user));\n\t\t\tcall.on('error', function(err){\n\t\t\t\tapp.error('answer', user.model.id, err);\n\t\t\t});\n\t\t});\n\t\tuser.peer.on('error', function(err){\n\t\t\tapp.error('peer', user.model.id, err);\n\t\t});\n\t}\n\n\tfunction toggleStream(user, auction) {\n\t\tif (user.stream) disconnectUserStream(user);\n\t\telse connectUserStream(user, auction);\n\t}\n\n\tfunction disconnectUserStream(user) {\n\t\tsetStream(user, null);\n\t\tuser.disconnect(app.guard());\n\t}\n\n\tfunction connectUserStream(user, auction) {\n\t\tnavigator.getUserMedia({ video: true }, function(stream){\n\t\t\tuser.connect(app.guard());\n\t\t\tsetStream(user, stream);\n\t\t\tshareStream(user, auction);\n\t\t}, app.guard());\n\t}\n\n\tfunction setStream(user, stream) {\n\t\tuser.stream = stream;\n\t\tvar videos = document.querySelectorAll('[data-user=\"'+user.model.id+'\"]');\n\t\tvar src = stream ? URL.createObjectURL(stream) : false;\n\t\tArray.prototype.slice.call(videos).forEach(function(video){\n\t\t\tif (src) video.src = src;\n\t\t\telse delete video.src;\n\t\t});\n\t}\n\n\tfunction shareStream(user, auction) {\n\t\tauction.users().forEach(function(their){\n\t\t\tif (!their.model.peer) return;\n\t\t\tif (their.model.id === user.model.id) return;\n\t\t\tvar call = user.peer.call(their.model.peer, user.stream);\n\t\t\tif (!call) return;\n\t\t\tcall.on('stream', acceptStream(their));\n\t\t\tcall.on('error', function(err){\n\t\t\t\tapp.error('call', their.model.id, err);\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction acceptStream(user) {\n\t\treturn function(stream) {\n\t\t\tsetStream(user, stream);\n\t\t}\n\t}\n\n\twindow.addEventListener('ready', main);\n\n})();"]}