/* RentGuppy (C) 2015 */
(function(){"use strict";var ELS={auctionName:document.getElementById("auction-name"),roommates:document.getElementById("roommates"),rooms:document.getElementById("rooms"),total:document.querySelector(".rent.total .dollars"),remaining:document.querySelector(".rent.remaining .dollars"),adder:document.querySelector(".adder")};Auction.load(location.hash.substr(1),main);function back(){app.navigate(location.pathname.replace("auction",""))}function main(err,auction){if(err)app.error(err);if(!auction)return back();var user=User.current();window.auction=auction;auction.addUser(user,app.guard(function(){addEventListeners(user,auction);addEventReceiver(auction);render(auction);utils.trigger(window,"ready",{auction:auction,user:user})}))}function addEventListeners(user,auction){addBidListener(user,auction);addNewRoomListener(auction);addRemoveRoomListener(auction);addFocusBidListener();addContentListeners()}function addFocusBidListener(){ELS.rooms.addEventListener("click",function(e){if(!utils.matches(e.target,".bids"))return;e.target.nextSibling.childNodes[0].focus()})}function addEventReceiver(auction){auction.ref().on("value",function(e){auction.model=e.val();render(auction.withDefaults())},app.guard())}function addContentListeners(){var target;function save(e){if(!target)return;var targeted=e.target===target;if(e.type==="click"&&targeted)return;else if(e.which!==13&&e.which!==27&&targeted)return;else if(e.type==="keyup")e.preventDefault();if(targeted)target.blur();var key="name";if(target.dataset.key)key=target.dataset.key;var source=target.parentNode.source;if(!source)throw new Error("unable to edit content without model source");source.model[key]=target.innerText;if(target.dataset.type==="number")source.model[key]=utils.cleanNumber(source.model[key]);source.save(app.guard());if(source.cache)source.cache()}function mark(e){if(!utils.matches(e.target,"[contenteditable=true]"))return;target=e.target}document.body.addEventListener("keydown",mark);document.body.addEventListener("paste",mark);document.body.addEventListener("input",mark);document.body.addEventListener("click",save);document.body.addEventListener("keydown",save)}function addBidListener(user,auction){ELS.rooms.addEventListener("submit",function(e){e.preventDefault();var bid=utils.cleanNumber(e.target.childNodes[0].value);var room=auction.room(e.target.parentNode.dataset.id);if(isNaN(bid))return app.error("please enter a valid bid amount");if(bid<1)return app.error("bids must be positive numbers");if(bid>ELS.remaining.value)return app.error("bids must be less than the remaining rent");room.placeBid(user,bid,app.guard(renderBid))})}function addNewRoomListener(auction){ELS.adder.addEventListener("click",function(e){e.preventDefault();auction.generateRoom(app.guard(renderRoom))})}function addRemoveRoomListener(auction){ELS.rooms.addEventListener("click",function(e){if(!utils.matches(e.target,".delete"))return;e.preventDefault();var target=e.target.parentNode;if(!target.source)throw new Error("unable to delete room, missing model source");auction.removeRoom(target.source,app.guard());if(target.parentNode)target.parentNode.removeChild(target)})}function render(auction){document.body.classList.remove("loading");renderUsers(auction);renderRooms(auction);renderAuctionCopy(auction);renderPrices(auction);utils.trigger(window,"rendered",{auction:auction})}function renderPrices(auction){var total=auction.model.rent;var rooms=auction.rooms();var size=rooms.length;var prices={};var sum=0;rooms.forEach(function(room){var model={id:room.model.id};var source={model:model};prices[room.model.id]=source;var bids=room.bids();switch(bids.length){case 0:return;case 1:model.value=bids[0].model.value;break;default:model.value=bids[1].model.value+1;break}source.value_class="user";source.user=bids[0].user;sum+=model.value;size--});var remaining=total-sum;var split=Math.ceil(remaining/size);rooms.forEach(function(room){var model=prices[room.model.id].model;if(!model.value)model.value=split});Object.keys(prices).forEach(function(id){var source=prices[id];var parent=ELS.rooms.querySelector('[data-id="'+id+'"] .price-container');source.model.formatted=utils.formatDollars(source.model.value);renderModel("price",source,parent)});ELS.remaining.value=remaining;ELS.remaining.innerText=utils.formatDollars(remaining)}function renderStreams(auction){auction.users().forEach(function(user){})}function renderAuctionCopy(auction){var total=auction.model.rent;ELS.total.parentNode.source=auction;ELS.auctionName.parentNode.source=auction;ELS.auctionName.innerText=auction.model.name;ELS.total.innerText=utils.formatDollars(total)}function renderUsers(auction){utils.pruneChildren(ELS.roommates,auction.model.users);auction.users().forEach(renderUser)}function renderRooms(auction){utils.pruneChildren(ELS.rooms,auction.model.rooms);auction.rooms().forEach(renderRoom)}function renderUser(user){renderModel("user",user,ELS.roommates)}function renderRoom(room){renderModel("room",room,ELS.rooms,true);renderBids(room)}function renderBids(room){var parent=ELS.rooms.querySelector('[data-id="'+room.model.id+'"] .bids');utils.pruneChildren(parent,room.model.bids);room.bids().forEach(function(bid){renderBid(bid,parent)})}function renderBid(bid,parent){if(!parent)parent=ELS.rooms.querySelector('[data-id="'+bid.room.model.id+'"] .bids');renderModel("bid",bid,parent)}function renderModel(template,source,parent,noupdates){var selector='[data-id="'+source.model.id+'"]';var existing=parent.querySelector(selector);if(existing){if(!noupdates){existing.outerHTML=templates.render(template,source);parent.querySelector(selector).source=source}}else{var node=templates.renderNode(template,source);node.source=source;parent.appendChild(node)}}templates.register("user",'<li class="user" data-id="{{ model.id }}">'+'<video autoplay data-user="{{ model.id }}" class="avatar" style="background-color:{{ model.color }}"></video>'+'<h3 contenteditable="{{ current }}">{{ model.name }}</h3>'+"</li>");templates.register("room",'<li class="room" data-id="{{ model.id }}">'+'<h3 contenteditable="true">{{ model.name }}</h3>'+'<a class="delete">&times;</a>'+'<ul class="bids"></ul>'+"<form>"+'<input class="bid" type="number" min="1" step="1" placeholder="Set bid..." />'+'<button type="submit">Bid!</button>'+'<div class="price-container"></div>'+"</form>"+"</li>");templates.register("price",'<div class="price" data-id="{{ model.id }}">'+'<video autoplay data-user="{{ user.model.id }}" class="avatar" style="background-color:{{ user.model.color }}"></video>'+'<h4 class="value {{ value_class }}">{{ model.formatted }}</h4>'+"</div>");templates.register("bid",'<li class="bid" data-id="{{ model.id }}">'+'<video autoplay data-user="{{ user.model.id }}" class="avatar" style="background-color:{{ user.model.color }}"></video>'+'<span class="value">${{ model.value }}</span>'+"</li>")})();(function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;function main(event){var user=event.detail.user;var auction=event.detail.auction;user.connect(app.guard());addEventListeners(user,auction);shareStream(user,auction)}function addEventListeners(user,auction){addVideoClickListener(user,auction);addPeerCallListeners(user);addExitListener(user);addRenderListener(auction)}function addRenderListener(auction){window.addEventListener("rendered",function(){auction.users().forEach(function(user){setStream(user,user.stream)})})}function addVideoClickListener(user,auction){document.addEventListener("click",function(e){if(!utils.matches(e.target,".user video"))return;var video=e.target;var node=video.parentNode;var source=node.source;if(!source)throw new Error("unable to modify video without source");if(source.model.id===user.model.id)toggleStream(user,auction)})}function addExitListener(user){window.addEventListener("beforeunload",function(){user.peer.disconnect(true,app.guard())})}function addPeerCallListeners(user){user.peer.on("call",function(call){var user=auction.peer(call.peer);call.answer(user.stream);call.on("stream",acceptStream(user));call.on("close",acceptStream(user));call.on("error",function(err){app.error("answer",user.model.id,err)})});user.peer.on("error",function(err){app.error("peer",user.model.id,err)})}function toggleStream(user,auction){if(user.stream)disconnectUserStream(user);else connectUserStream(user,auction)}function disconnectUserStream(user){setStream(user,null);user.disconnect(app.guard())}function connectUserStream(user,auction){navigator.getUserMedia({video:true},function(stream){user.connect(app.guard());setStream(user,stream);shareStream(user,auction)},app.guard())}function setStream(user,stream){user.stream=stream;var videos=document.querySelectorAll('[data-user="'+user.model.id+'"]');var src=stream?URL.createObjectURL(stream):false;Array.prototype.slice.call(videos).forEach(function(video){if(src)video.src=src;else delete video.src})}function shareStream(user,auction){auction.users().forEach(function(their){if(!their.model.peer)return;if(their.model.id===user.model.id)return;var call=user.peer.call(their.model.peer,user.stream);if(!call)return;call.on("stream",acceptStream(their));call.on("error",function(err){app.error("call",their.model.id,err)})})}function acceptStream(user){return function(stream){setStream(user,stream)}}window.addEventListener("ready",main)})();
//# sourceMappingURL=auction.map.json